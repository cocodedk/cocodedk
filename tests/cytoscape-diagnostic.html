<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cytoscape Diagnostic</title>

  <!-- Cytoscape.js library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.24.0/cytoscape.min.js" referrerpolicy="no-referrer"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }

    #cy {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      margin-bottom: 20px;
    }

    .controls {
      margin-bottom: 20px;
    }

    .log {
      background-color: #f5f5f5;
      padding: 10px;
      border: 1px solid #ddd;
      height: 200px;
      overflow-y: auto;
      font-family: monospace;
    }

    button {
      padding: 8px 16px;
      margin-right: 10px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #3367d6;
    }

    h1 {
      margin-top: 0;
    }
  </style>
</head>
<body>
  <h1>Cytoscape Diagnostic Tool</h1>

  <div class="controls">
    <button id="createGraph">Create Test Graph</button>
    <button id="addNode">Add Node</button>
    <button id="clearGraph">Clear Graph</button>
    <button id="checkStatus">Check Status</button>
  </div>

  <div id="cy"></div>

  <h3>Log</h3>
  <div id="log" class="log"></div>

  <script>
    // Log function
    function log(message) {
      const logElem = document.getElementById('log');
      const line = document.createElement('div');
      line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logElem.appendChild(line);
      logElem.scrollTop = logElem.scrollHeight;
    }

    // Initialize Cytoscape
    let cy = null;

    function initCytoscape() {
      try {
        log('Initializing Cytoscape...');

        cy = cytoscape({
          container: document.getElementById('cy'),
          style: [
            {
              selector: 'node',
              style: {
                'background-color': '#0077cc',
                'label': 'data(label)',
                'color': '#ffffff',
                'text-valign': 'center',
                'text-halign': 'center',
                'width': 60,
                'height': 60,
                'border-width': '2px',
                'border-color': '#33ccff'
              }
            },
            {
              selector: 'edge',
              style: {
                'width': 2,
                'line-color': '#999',
                'curve-style': 'bezier',
                'target-arrow-shape': 'triangle'
              }
            }
          ]
        });

        log('Cytoscape initialized successfully');
        return true;
      } catch (error) {
        log(`Error initializing Cytoscape: ${error.message}`);
        return false;
      }
    }

    // Create a test graph
    function createTestGraph() {
      if (!cy) {
        if (!initCytoscape()) {
          return;
        }
      }

      try {
        // Clear existing elements
        cy.elements().remove();

        // Add nodes
        const nodes = [
          { data: { id: 'a', label: 'Node A' }, position: { x: 100, y: 100 } },
          { data: { id: 'b', label: 'Node B' }, position: { x: 200, y: 200 } },
          { data: { id: 'c', label: 'Node C' }, position: { x: 100, y: 300 } },
          { data: { id: 'd', label: 'Node D' }, position: { x: 300, y: 100 } }
        ];

        // Add edges
        const edges = [
          { data: { id: 'ab', source: 'a', target: 'b' } },
          { data: { id: 'ac', source: 'a', target: 'c' } },
          { data: { id: 'cd', source: 'c', target: 'd' } },
          { data: { id: 'bd', source: 'b', target: 'd' } }
        ];

        cy.add([...nodes, ...edges]);

        // Apply layout
        cy.layout({ name: 'grid' }).run();

        log(`Created test graph with ${nodes.length} nodes and ${edges.length} edges`);
      } catch (error) {
        log(`Error creating test graph: ${error.message}`);
      }
    }

    // Add a node
    function addNode() {
      if (!cy) {
        if (!initCytoscape()) {
          return;
        }
      }

      try {
        // Create a random ID
        const id = 'node-' + Math.floor(Math.random() * 1000);

        // Add the node at a random position
        const x = Math.random() * 300 + 50;
        const y = Math.random() * 300 + 50;

        const newNode = {
          group: 'nodes',
          data: { id: id, label: `Node ${id}` },
          position: { x: x, y: y }
        };

        cy.add(newNode);

        log(`Added node with ID: ${id}`);

        // Connect to a random existing node
        const existingNodes = cy.nodes().filter(node => node.id() !== id);

        if (existingNodes.length > 0) {
          const randomIndex = Math.floor(Math.random() * existingNodes.length);
          const targetNode = existingNodes[randomIndex];

          const newEdge = {
            group: 'edges',
            data: {
              id: `edge-${id}-${targetNode.id()}`,
              source: id,
              target: targetNode.id()
            }
          };

          cy.add(newEdge);
          log(`Added edge from ${id} to ${targetNode.id()}`);
        }
      } catch (error) {
        log(`Error adding node: ${error.message}`);
      }
    }

    // Clear the graph
    function clearGraph() {
      if (!cy) {
        log('Cytoscape not initialized');
        return;
      }

      try {
        cy.elements().remove();
        log('Graph cleared');
      } catch (error) {
        log(`Error clearing graph: ${error.message}`);
      }
    }

    // Check Cytoscape status
    function checkStatus() {
      if (!cy) {
        log('Cytoscape not initialized');
        return;
      }

      try {
        const nodeCount = cy.nodes().length;
        const edgeCount = cy.edges().length;

        log(`Status: ${nodeCount} nodes, ${edgeCount} edges`);

        if (nodeCount === 0) {
          log('WARNING: No nodes in the graph');
        }

        // Test adding a single node directly
        const testId = 'test-' + Date.now();
        cy.add({
          group: 'nodes',
          data: { id: testId, label: 'Test Node' },
          position: { x: 150, y: 150 }
        });

        log(`Test node added: ${testId}`);
        log(`New node count: ${cy.nodes().length}`);
      } catch (error) {
        log(`Error checking status: ${error.message}`);
      }
    }

    // Event listeners
    document.getElementById('createGraph').addEventListener('click', createTestGraph);
    document.getElementById('addNode').addEventListener('click', addNode);
    document.getElementById('clearGraph').addEventListener('click', clearGraph);
    document.getElementById('checkStatus').addEventListener('click', checkStatus);

    // Initialize on load
    document.addEventListener('DOMContentLoaded', function() {
      log('Page loaded');
      initCytoscape();
    });
  </script>
</body>
</html>
